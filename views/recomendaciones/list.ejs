<%- include('../includes/head.ejs') %>

<h1 class="title is-large">Estas son tus recomendaciones</h1>
<div class="container">
    <div class="field is-grouped is-grouped-right">
        <a href="/recomendaciones/nueva_recomendacion"><button class="button is-primary">Nueva Recomendación</button></a>
    </div>
    <p>Buscar</p>
    <input id="buscar" class="input is-normal" type="text" placeholder="Buscar"><button class="button is-primary">Buscar</button>
</div>
<div id="resultados">
    <div class="container">
        <div class="columns is-multiline">
            <% if (recomendaciones.length > 0) { %>              
                <% for (let r of recomendaciones) { %>
                    <div class="column is-one-quarter">
                    <%- include('card.ejs', {recomendacion: r}) %>
                    </div>
                <% } %>
            <% } else { %>
                <h2 class="title is-large">No hay recomendaciones registradas.</h2>
            <% } %>
        </div>
    </div>
</div> 


<div class="field is-grouped is-grouped-right">
    <a href="/recomendaciones/nueva_recomendacion"><button class="button is-primary">Nueva Recomendación</button></a>
</div>

<% if (ultimo_recomendacion != '') { %>
    <p>La ultima recomendacion registrado fue: <%= ultimo_recomendacion %></p>
<% } %>

<script>
    accion_asincrona = () => {
        let valor_busqueda = document.getElementById('buscar').value;
        //función que manda la petición asíncrona
        fetch('/recomendaciones/buscar/' + valor_busqueda, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(result => {
            return result.json(); //Regresa otra promesa
        }).then(data => {
            //Modificamos el DOM de nuestra página de acuerdo a los datos de la segunda promesa
            console.log(data);
            let html = '';
            html += '<div class="container">';
    html += '<div class="columns is-multiline">';
    if (data.length > 0) { 
        for (let recomendacion of data) { 
            html += '<div class="column is-one-quarter">';
                html += '<div class="card">';
                    html += '<div class="card-image">';
                        html += '<figure class="image" >';
                            html += '<img src="'+ recomendacion.img + '" alt="Placeholder image" >';
                        html += '</figure>';
                    html += '</div>';

                    html += '<div class="card-content">';
                        html += '<div class="media">';
                            html += '<div class="media-left">';
                                html += '<figure class="image is-48x48">';
                                    html += '<img src="https://images.vexels.com/media/users/3/153232/isolated/preview/c3bcb676107e330558ccc68f8e1cf7d5-icono-plano-del-reproductor-de-peliculas.png" alt="Placeholder image" > ';
                                html += '</figure>';
                            html += '</div>';
                        
                            html += '<div class="media-content">';
                                html += '<p class="title is-4">' + recomendacion.nombre + '</p>';
                                html += '<p class="subtitle is-6"> </p>';
                            html += '</div>';
                        html += '</div>';

                        html += '<div class="content">';
                            html += '' + recomendacion.descripcion + '';
                            html += '<p><a href="/recomendaciones/edit/'+recomendacion.id +'"> Editar</a></p>';
                        html += '</div>';
                    html += '</div>';
                html += '</div>';
            html += '</div>';
        } 
    } else { 
        html += '<h3>No hay recomendaciones registradas.</h3>';
    } 
    html += '</div>';
    html += '</div>';
            document.getElementById('resultados').innerHTML = html;
        }).catch(err => {
            console.log(err);
        });
    }
    document.getElementById('buscar').onkeyup = accion_asincrona;
</script>

<%- include('../includes/foot.ejs') %>